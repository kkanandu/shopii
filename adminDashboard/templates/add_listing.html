{% extends 'header.html' %}
{% load static %}

{% block header %}
{% if messages %}
{% for i in messages %}
{% if i.level == DEFAULT_MESSAGE_LEVELS.WARNING%}
<div class="alert alert-warning alert-dismissible fade show" role="alert">
    {{ i }}
    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
</div>
{% endif %}
{% endfor %}
{% endif %}

<div class="container my-5">
  <div class="row justify-content-center">
    <div class="col-md-8">
      <div class="card shadow-lg border-0 rounded-4 animate__animated animate__fadeInUp">
        <div class="card-header bg-primary text-white text-center rounded-top-4">
          <h4 class="mb-0">üìù Add New Listing</h4>
        </div>
        <div class="card-body p-4 bg-light">
          <form method="POST" enctype="multipart/form-data" novalidate>
            {% csrf_token %}
            <!-- category -->
            <div class="mb-3">
              <label for="{{ form.category.id_for_label }}" class="form-label">{{ form.category.label }}</label>
              {{ form.category }}
              {% if form.category.errors %}
              <div class="text-danger small">{{ form.category.errors|join:", " }}</div>
              {% endif %}
            </div>

            <!-- House Type -->
            {% if form.house_type %}
            <div class="mb-3" id="house-type-field" style="display: none;">
              <label for="{{ form.house_type.id_for_label }}" class="form-label">{{ form.house_type.label }}</label>
              {{ form.house_type }}
              {% if form.house_type.errors %}
              <div class="text-danger small">{{ form.house_type.errors|join:", " }}</div>
              {% endif %}
            </div>
            {% endif %}
            <div class="mb-3" id="transaction-type-field" style="display: none;">
              <label for="{{ form.transaction_type.id_for_label }}" class="form-label">{{ form.transaction_type.label }}</label>
              {{ form.transaction_type }}
              {% if form.transaction_type.errors %}
              <div class="text-danger small">{{ form.transaction_type.errors|join:", " }}</div>
              {% endif %}
            </div>
            <!-- Main image -->

            <div class="mb-3">
              <label for="{{ form.product_image.id_for_label }}" class="form-label">{{ form.product_image.label}}</label>
              {{ form.product_image }}
              {% if form.product_image.errors %}
              <div class="text-danger small">{{ form.product_image.errors|join:", " }}</div>
              {% endif %}
            </div>

            <!-- Multiple images -->
            <div class="mb-3">
              <label class="form-label">Additional Images (max 5)</label>
              <div style="display:flex; gap:10px; flex-wrap: wrap;">
                {% for i in "12345" %}
                <label for="id_images_{{i}}"
                  style="width:100px; height:100px; border: 2px dashed #ccc; display:flex; justify-content:center; align-items:center; cursor:pointer; position:relative; overflow:hidden;">
                  
                  <input type="file" name="images" id="id_images_{{i}}" style="display:none;" accept="image/*" onchange="previewImage(this)">
                  <span class="plus-icon" style="font-size: 40px; color: #aaa;">+</span>
                  <img id="preview_{{i}}" src="" alt="preview" style="max-width: 100%; max-height: 100%; display: none; position:absolute;" />
                </label>
                {% endfor %}
              </div>
            </div>
            
            <!-- <div class="mb-3">
              <label class="form-label">Additional Images (max 5)</label>
              <div style="display:flex; gap:10px; flex-wrap: wrap;">
                {% for i in "12345" %}
                <label for="id_images_{{i}}"
                  style="width:100px; height:100px; border: 2px dashed #ccc; display:flex; justify-content:center; align-items:center; cursor:pointer; position:relative;">
                  <input type="file" name="images" id="id_images_{{i}}" style="display:none;" accept="image/*">
                  <span style="font-size: 40px; color: #aaa;">+</span>
                </label>
                {% endfor %}
              </div>
            </div> -->

            <!-- Other fields -->
            {% for field in form %}
            {% if field.name != 'category' and field.name != 'house_type' and field.name != 'product_image' and field.name != 'transaction_type' %}

            <div class="mb-3">
              <label for="{{ field.id_for_label }}" class="form-label">{{ field.label }}</label>
              {{ field }}
              {% if field.errors %}
              <div class="text-danger small">{{ field.errors|join:", " }}</div>
              {% endif %}
            </div>
            {% endif %}
            {% endfor %}


            <div class="text-center">
              <button type="submit" class="btn btn-success px-4 py-2 rounded-pill shadow">
                <i class="fas fa-plus-circle"></i> Add Listing
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
<script>
  document.addEventListener('DOMContentLoaded', function () {
    const categoryField = document.getElementById("id_category");
    const houseTypeField = document.getElementById("house-type-field");
    const transactionTypeField = document.getElementById("transaction-type-field");
    const houseTypeSelect = document.getElementById("id_house_type");
    const transactionTypeSelect = document.getElementById("id_transaction_type");

    function toggleFields() {
      const category = categoryField.value;

      // Handle house_type
      if (category === "house") {
        houseTypeField.style.display = "block";
      } else {
        houseTypeField.style.display = "none";
        if (houseTypeSelect) houseTypeSelect.value = "";
      }

      // Reset and show transaction_type field
      if (category === "") {
        transactionTypeField.style.display = "none";
        transactionTypeSelect.value = "";
        return;
      }

      // Show transaction_type field
      transactionTypeField.style.display = "block";

      // Show/hide 'buy' option
      const buyOption = Array.from(transactionTypeSelect.options).find(opt => opt.value === "buy");
      if (buyOption) {
        buyOption.style.display = (category === "bike") ? "none" : "block";
      }
    }

    categoryField.addEventListener("change", toggleFields);
    if (houseTypeSelect) houseTypeSelect.addEventListener("change", toggleFields);

    toggleFields();  // Initial call
  });
</script>
<script>
  function previewImage(input) {
    const previewId = "preview_" + input.id.split("_").pop();
    const previewImg = document.getElementById(previewId);
    const plusIcon = input.nextElementSibling;

    if (input.files && input.files[0]) {
      const reader = new FileReader();

      reader.onload = function (e) {
        previewImg.src = e.target.result;
        previewImg.style.display = "block";
        if (plusIcon) plusIcon.style.display = "none";
      };

      reader.readAsDataURL(input.files[0]);
    }
  }
</script>

<!-- <script>
  document.addEventListener('DOMContentLoaded', function () {
    const categoryField = document.getElementById("id_category");
    const houseTypeField = document.getElementById("house-type-field");
    const transactionTypeField = document.getElementById("transaction-type-field");
    const houseTypeSelect = document.getElementById("id_house_type");
  
    function toggleFields() {
      // Show house_type if category is 'house'
      if (categoryField.value === "house") {
        houseTypeField.style.display = "block";
      } else {
        houseTypeField.style.display = "none";
        houseTypeSelect.value = "";  // reset house_type if hidden
      }
  
      // Show transaction_type only if category is selected and
      // if category is house, only after house_type selected
      if (categoryField.value === "") {
        transactionTypeField.style.display = "none";
        document.getElementById("id_transaction_type").value = "";
        return;
      }
  
      if (categoryField.value === "house") {
        if (houseTypeSelect.value) {
          transactionTypeField.style.display = "block";
        } else {
          transactionTypeField.style.display = "none";
          document.getElementById("id_transaction_type").value = "";
        }
      } else {
        // For 'bike' category, show transaction type immediately after category
        transactionTypeField.style.display = "block";
      }
    }
  
    categoryField.addEventListener("change", toggleFields);
    houseTypeSelect.addEventListener("change", toggleFields);
    
    toggleFields();  // initial call on page load
  });
  </script> -->
  
{% endblock %}