{% extends 'header.html' %}
{% load static %}
{% load humanize %}

{% block header %}
<!-- Hero Banner -->
<div class="container-fluid p-0">
  <div class="position-relative">
    <img src="{% static 'assets/banner.jpg' %}" class="img-fluid w-100" style="max-height: 300px; object-fit: cover;" alt="Banner">
    <div class="position-absolute top-50 start-50 translate-middle text-white text-center">
      <h2 class="display-5 fw-bold animate__animated animate__fadeInDown">Confirm Your Stay</h2>
    </div>
  </div>
</div>

<!-- Description -->
<div class="container mt-5 text-center">
  <h3 class="fw-semibold">Your Ideal Rental, Just a Few Clicks Away</h3>
  <p class="text-muted">Secure your perfect stay by chatting with the owner, clearing your queries, and making a quick payment once confirmed.</p>
</div>

<!-- Info Boxes -->
<div class="container my-5">
  <div class="row g-4">
    <!-- Know More -->
    <div class="col-md-6">
      <div class="bg-warning text-dark p-4 rounded shadow-sm h-100 text-center animate__animated animate__fadeIn">
        <h5 class="fw-bold">Chat with Us to Know More</h5>
        <p>Discuss details like facilities, locality, and more...</p>
        {% if booking.product.user %}
        <a class="btn btn-light" href="{% url 'chat_room' receiver_id=booking.product.user.id %}">Go to Chat</a>
        {% endif %}
      </div>
    </div>

    <!-- Close the Deal -->
    <div class="col-md-6">
      <div class="bg-success text-white p-4 rounded shadow-sm h-100 text-center animate__animated animate__fadeIn">
        <h5 class="fw-bold">Close the Deal</h5>
        <p>Already convinced? Then lock the property with a secured payment.</p>

        {% if booking and booking.id %}
        <button type="button" class="btn btn-outline-light" onclick="showPaymentForm()">Pay Me</button>
        {% else %}
        <p class="text-warning">Booking information not available.</p>
        {% endif %}
      </div>
    </div>
  </div>
</div>

<!-- Hidden Animated Payment Details Form -->
<div id="payment-form" class="container d-none animate__animated">
  <div class="card shadow-sm p-4 mt-4">
    <!-- <div class="d-flex justify-content-between align-items-center"> -->
      <h5 class="mb-4 text-success">üîç Review Booking Details</h5>
      <!-- <a href="#" class="text-decoration-none text-muted">
        <i class="fa-solid fa-pen-to-square" style="font-size: 20px;"></i>
      </a> -->
    <!-- </div> -->
    
    <ul class="list-group list-group-flush mb-4">
      <li class="list-group-item"><strong>Rent:</strong> ‚Çπ{{ booking.product.price }}</li>
      <li class="list-group-item"><strong>Owner Name:</strong> {{ booking.product.user.username }}</li>
      <li class="list-group-item"><strong>Username:</strong> {{ booking.user.username }}</li>
      <li class="list-group-item"><strong>Phone:</strong> {{ booking.user.phone }}</li>
      <li class="list-group-item"><strong>House Type:</strong> {{ booking.product.house_type|title }}</li>
      <li class="list-group-item"><strong>Transaction Type:</strong> {{ booking.product.get_transaction_type_display }}</li>
      <li class="list-group-item"><strong>Address:</strong> {{ user.address }}</li>
    </ul>

    <a href="{% url 'demo' booking.id %}" class="btn btn-success">Ready to Pay</a>

  </div>
</div>


<!-- Chat & Payment Section -->
<div id="chat-payment-section" class="container mt-4 d-none animate__animated">
  <div class="row g-4">

    <!-- Chat -->
    <div class="col-md-6">
      <div class="border rounded p-4 shadow-sm h-100 d-flex flex-column position-relative">
        <h4 class="mb-3">Chat with the Owner</h4>
        {% if user == booking.product.user or user == booking.user %}
        <button type="button" class="btn btn-sm btn-danger position-absolute top-0 end-0 m-2" onclick="hideChatSection()">Close Chat</button>
        {% endif %}

        <div class="chat-box border rounded p-3 mb-3 flex-grow-1 overflow-auto" style="max-height: 300px;">
          {% if booking.chat_messages.all %}
            {% for msg in booking.chat_messages.all %}
              <div class="mb-2">
                <strong>{{ msg.user.username }}:</strong> {{ msg.message|linebreaksbr }}
                <small class="text-muted d-block">{{ msg.timestamp|naturaltime }}</small>
              </div>
            {% endfor %}
          {% else %}
            <p class="text-muted">No messages yet. Start the conversation!</p>
          {% endif %}
        </div>

        {% if user == booking.product.user or user == booking.user %}
        <form method="post" action="">
          {% csrf_token %}
          <div class="input-group">
            <input type="text" name="message" class="form-control" placeholder="Type your message..." required autocomplete="off">
            <button type="submit" class="btn btn-primary">Send</button>
          </div>
        </form>
        {% else %}
        <div class="alert alert-warning mt-3">You are not authorized to send messages for this booking.</div>
        {% endif %}
      </div>
    </div>

  </div>
</div>

<!-- Styles -->
<style>
  .blur {
    filter: blur(4px);
    pointer-events: none;
    user-select: none;
  }

  .chat-box::-webkit-scrollbar {
    width: 8px;
  }

  .chat-box::-webkit-scrollbar-thumb {
    background-color: rgba(0, 0, 0, 0.2);
    border-radius: 4px;
  }
</style>

<!-- JavaScript -->
<script>
  function showChatSection() {
    const section = document.getElementById('chat-payment-section');
    section.classList.remove('d-none');
    section.classList.add('animate__fadeIn');
    section.scrollIntoView({ behavior: 'smooth' });
  }

  function hideChatSection() {
    const section = document.getElementById('chat-payment-section');
    section.classList.add('d-none');
  }

  function showPaymentForm() {
    const form = document.getElementById('payment-form');
    form.classList.remove('d-none');
    form.classList.add('animate__fadeIn');
    form.scrollIntoView({ behavior: 'smooth' });
  }
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.min.js"
    integrity="sha384-BBtl+eGJRgqQAUMxJ7pMwbEyER4l1g+O15P+16Ep7Q9Q+zqX6gSbd85u4mG4QzX+"
    crossorigin="anonymous"></script>
{% endblock %}
